---
title: "p8105_hw6_ma4197"
author: "Mayuri Albal"
date: "2022-12-02"
output: html_document
---

```{r}
library(tidyverse)
library(modelr)
library(mgcv)
library(rvest)
```

##Problem 2

*Data Loading*
```{r}
twp_data = read_csv(file= "./data/homicide-data.csv") %>%
janitor::clean_names()
```


*Data Cleaning*
```{r}
murder_df=
twp_data %>%
janitor::clean_names() %>% 
mutate(
  state = replace(state, state== "wI", "WI")) %>% 
mutate(
  city_state= paste(city, state, sep= ",")) %>% 
mutate(
  victim_age = as.numeric(victim_age)) %>% 
filter(!city_state %in% c("Dallas,TX","Phoenix,AZ", "Kansas City,MO","Tulsa,AL" )) %>% 
filter(victim_race %in% c("White","Black")) %>% 
mutate(
    resolved = as.numeric(disposition == "Closed by arrest"))

```
*Checks*
```{r}
murder_df %>% 
  group_by(city_state) %>% 
  count(city_state)
```
```{r}
murder_df %>% 
  summarise(victim_age)
```
```{r}
murder_df %>% 
  count(victim_race)
```
*Linear Model*

```{r}
balt_murder_logfit = 
  murder_df %>% 
  filter(city_state == "Baltimore,MD") %>% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 
```

```{r}
balt_murder_logfit %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)
```
```{r}
conf= exp(confint(balt_murder_logfit, level= 0.95))
```


Within the city of Baltimore,MD, the odds of solving a homicide case for a male victim is 0.426 times higher than the odds of solving a homicide case for a female victim, adjusting for the victim's sex and race. We are 95% confident that the true odds of solving a homicide case for a male victim within the Baltimore,MD is between 0.3241 and 0.5575.

*All City Pipeline*
```{r}
allcity_murder=
  murder_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    ac_models = map(data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())),
    results = purrr::map(ac_models, broom::tidy, conf.int = TRUE)) %>% 
  select(city_state, results) %>% 
  unnest(cols = results) 
```

```{r}
all_city=
allcity_murder %>% 
  filter(term== "victim_sexMale") %>% 
  mutate(OR = exp(estimate),
         confh= exp(conf.high),
         confl= exp(conf.low)) %>%
  select(city_state, log_OR = estimate, OR, p.value, confl, confh)
```

```{r}
all_city=
all_city %>% 
mutate(city_state= fct_reorder(city_state, OR))
```

*Plotting*

```{r}
ggplot(all_city, aes(x= city_state, y= OR, color=city_state))+
  geom_point()+
  geom_errorbar(aes(ymin=confl, ymax= confh))+
  theme_classic()+ 
  theme(legend.position= "none")+
  ggtitle("Odds Ratio of Resolved Homicide Cases,Comparing Males to Females, in Large US Cities")+
  theme(plot.title = element_text(hjust= 0.5, size=12),
        axis.text.x.bottom = element_text(size= 7, angle= 90))+
    labs(x = "City",
        y= "Odds Ratio")
```
The estimated OR of resolved homicides, comparing male victims and female victims, for each of the 50 largest cities in the US were graphed in order of lowest to highest OR. New York, NY has the lowest OR for resolved cases of male victims compared to female victims, showing the odds of solving homicide cases for male victims compared to female victims is low. Whilst Albuquerque,NM has the highest, this demonstrates higher odds of solving homicide cases for male victims compared to female victims. Each was fitted with a error bar based upon the lowest and highest values from the estimates 95% confidence interval generated for the Odds Ratio.


##Problem 3